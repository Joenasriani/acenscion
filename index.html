<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <title>Ascension VR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;300;400;600&display=swap" rel="stylesheet">
    <style>
      body {
        margin: 0;
        font-family: 'Montserrat', sans-serif;
        background-color: #000;
        overflow: hidden;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
      }
      #root {
        width: 100vw;
        height: 100vh;
      }
      /* Custom Scrollbar for philosophical text */
      ::-webkit-scrollbar {
        width: 6px;
      }
      ::-webkit-scrollbar-track {
        background: transparent;
      }
      ::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.1);
        border-radius: 10px;
      }
      #loading {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: #000;
        color: #fff;
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        font-weight: 100;
        letter-spacing: 0.2em;
        transition: opacity 0.5s;
      }
    </style>
  <script type="importmap">
{
  "imports": {
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "@react-three/fiber": "https://aistudiocdn.com/@react-three/fiber@^9.4.2",
    "@react-three/drei": "https://aistudiocdn.com/@react-three/drei@^10.7.7",
    "three": "https://aistudiocdn.com/three@^0.181.2"
  }
}
</script>
</head>
  <body>
    <div id="loading">INITIALIZING REALITY...</div>
    <div id="root"></div>

    <script>
      // Browser-side compilation loader for GitHub Pages
      // This allows raw .tsx files to run without a build step.
      (async () => {
        const files = [
          './types.ts',
          './constants.ts',
          './services/audioService.ts',
          './services/geminiService.ts',
          './components/Character.tsx',
          './components/GameScene.tsx',
          './App.tsx',
          './index.tsx'
        ];

        const imports = {
          "react": "https://esm.sh/react@18.2.0",
          "react/": "https://esm.sh/react@18.2.0/",
          "react-dom": "https://esm.sh/react-dom@18.2.0",
          "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
          "three": "https://esm.sh/three@0.161.0",
          "@react-three/drei": "https://esm.sh/@react-three/drei@9.102.0?external=react,react-dom,three,@react-three/fiber",
          "@react-spring/three": "https://esm.sh/@react-spring/three@9.7.3?external=react,react-dom,three,@react-three/fiber",
          "@react-three/fiber": "https://esm.sh/@react-three/fiber@8.15.16?external=react,react-dom,three"
        };

        try {
          // 1. Fetch and compile all files
          const blobs = {};
          
          for (const file of files) {
            const response = await fetch(file);
            if (!response.ok) throw new Error(`Failed to load ${file}`);
            const text = await response.text();
            
            // Transform TSX/TS to JS
            const output = Babel.transform(text, {
              presets: ['react', 'typescript'],
              filename: file,
            }).code;

            // Create Blob URL
            const blob = new Blob([output], { type: 'application/javascript' });
            const url = URL.createObjectURL(blob);
            
            // Map file path (e.g., "./App") to Blob URL
            // We map both with and without extension to handle various import styles
            const cleanName = file.replace('.tsx', '').replace('.ts', '');
            imports[file] = url;
            imports[cleanName] = url;
          }

          // 2. Inject Import Map
          const map = document.createElement('script');
          map.type = 'importmap';
          map.textContent = JSON.stringify({ imports });
          document.head.appendChild(map);

          // 3. Load Entry Point
          const script = document.createElement('script');
          script.type = 'module';
          script.src = imports['./index.tsx'];
          document.body.appendChild(script);

          // 4. Hide Loading Screen
          script.onload = () => {
             setTimeout(() => {
                const loader = document.getElementById('loading');
                if(loader) {
                    loader.style.opacity = '0';
                    setTimeout(() => loader.remove(), 500);
                }
             }, 500);
          };

        } catch (err) {
          console.error(err);
          document.getElementById('loading').textContent = "ERROR: " + err.message;
        }
      })();
    </script>
  </body>
</html>